name: Publish iOS and Android App to App Store and Play Store
on:
  push:
    tags:
      - "v*"

env: 
  # common env :
  DOTENV_B64: ${{ secrets.DOTENV_B64 }}
  # android env :
  GOOGLE_CLOUD_API_KEY_B64: ${{ secrets.GOOGLE_CLOUD_API_KEY_B64 }}
  KEY_PROPERTIES_B64: ${{ secrets.KEY_PROPERTIES_B64 }}
  KEYSTORE_B64: ${{ secrets.KEYSTORE_B64 }}
  # ios env :


jobs:
  release-android:
    name: Build and release Android app
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: "14.x"

      - name: Setup JDK 11
        uses: actions/setup-java@v2
        with:
          distribution: "zulu"
          java-version: 11
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - uses: actions/setup-ruby@v1
        with:
          ruby-version: "2.x"

      - name: Write .env
        shell: bash
        run: |
          echo "$DOTENV_B64" | base64 --decode > .env

      - name: Write Google Cloud API Key
        shell: bash
        run: |
          echo "$GOOGLE_CLOUD_API_KEY_B64" | base64 --decode > android/google-cloud-api-key.json

      - name: Write key properties
        shell: bash
        run: |
          echo "$KEY_PROPERTIES_B64" | base64 --decode > android/key.properties

      - name: Write key store
        shell: bash
        run: |
          mkdir android/app/keystore
          echo "$KEYSTORE_B64" | base64 --decode > android/app/keystore/my-upload-key.jks

      - name: Install Fastlane
        run: cd android && bundle install && cd ..

      - name: Install packages
        run: yarn install

      - name: Execute Fastlane command
        run: cd android && fastlane internal